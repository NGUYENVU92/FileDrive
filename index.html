<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive File Manager - OAuth Authentication</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .auth-section {
            text-align: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #667eea;
        }

        .user-details h3 {
            color: #333;
            margin-bottom: 5px;
        }

        .user-details p {
            color: #666;
            font-size: 0.9rem;
        }

        .btn {
            display: inline-block;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.05);
        }

        .file-input {
            display: none;
        }

        .file-upload-label {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .file-upload-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .file-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .file-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .file-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .file-name {
            font-weight: 600;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .file-info {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .pagination {
            text-align: center;
            margin-top: 20px;
        }

        .pagination button {
            margin: 0 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .card {
                padding: 20px;
            }

            .user-info {
                flex-direction: column;
            }

            .files-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîê Google Drive File Manager</h1>
            <p>Qu·∫£n l√Ω t·∫£i l√™n v√† t·∫£i xu·ªëng file t·ª´ Google Drive</p>
        </div>

        <!-- Authentication Section -->
        <div class="card">
            <div class="auth-section">
                <h2>üîë X√°c th·ª±c t√†i kho·∫£n</h2>
                
                <!-- Sign In Button -->
                <div id="signInSection">
                    <p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng Google Drive API</p>
                    <div id="g_id_onload"
                         data-client_id="851875117831-l135siesbo6sdeo3i7ttkhm8d2v0ldko.apps.googleusercontent.com"
                         data-callback="handleCredentialResponse"
                         data-auto_prompt="false">
                    </div>
                    <div class="g_id_signin"
                         data-type="standard"
                         data-size="large"
                         data-theme="outline"
                         data-text="signin_with"
                         data-shape="rectangular"
                         data-logo_alignment="left">
                    </div>
                </div>

                <!-- User Info -->
                <div id="userSection" class="hidden">
                    <div class="user-info">
                        <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
                        <div class="user-details">
                            <h3 id="userName"></h3>
                            <p id="userEmail"></p>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="signOut()">ƒêƒÉng xu·∫•t</button>
                </div>
            </div>
        </div>

        <!-- File Upload Section -->
        <div id="uploadSection" class="card hidden">
            <h2>üì§ T·∫£i l√™n file</h2>
            <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                <div>
                    <span style="font-size: 3rem;">üìÅ</span>
                    <p>Nh·∫•p ƒë·ªÉ ch·ªçn file ho·∫∑c k√©o th·∫£ file v√†o ƒë√¢y</p>
                    <label for="fileInput" class="file-upload-label">Ch·ªçn File</label>
                    <input type="file" id="fileInput" class="file-input" onchange="uploadFile()" multiple>
                </div>
            </div>
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="uploadMessage"></div>
        </div>

        <!-- File List Section -->
        <div id="filesSection" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üìÅ Danh s√°ch file</h2>
                <button class="btn btn-primary" onclick="loadFiles()">
                    <span id="refreshIcon">üîÑ</span> L√†m m·ªõi
                </button>
            </div>
            <div id="filesGrid" class="files-grid"></div>
            <div class="pagination">
                <button id="prevPage" class="btn btn-secondary" onclick="previousPage()" disabled>‚óÄ Tr∆∞·ªõc</button>
                <span id="pageInfo">Trang 1</span>
                <button id="nextPage" class="btn btn-secondary" onclick="nextPage()" disabled>Sau ‚ñ∂</button>
            </div>
        </div>
    </div>

    <!-- Google API Libraries -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        // C·∫•u h√¨nh API v√† OAuth
        const CLIENT_ID = '851875117831-l135siesbo6sdeo3i7ttkhm8d2v0ldko.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDCinI3hWaCNus8kHWxoHN9kqCNIWuZY8M';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        // Bi·∫øn l∆∞u tr·∫°ng th√°i
        let gapi;
        let accessToken = null;
        let userInfo = null;
        let currentPageToken = null;
        let previousPageTokens = [];

        // Kh·ªüi t·∫°o Google API khi trang load
        window.onload = function() {
            gapi.load('client', initializeGapi);
        };

        // Kh·ªüi t·∫°o Google API Client
        async function initializeGapi() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
                console.log('Google API ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o th√†nh c√¥ng');
            } catch (error) {
                console.error('L·ªói kh·ªüi t·∫°o Google API:', error);
                showMessage('L·ªói kh·ªüi t·∫°o Google API: ' + error.message, 'error');
            }
        }

        // X·ª≠ l√Ω ph·∫£n h·ªìi ƒëƒÉng nh·∫≠p OAuth
        async function handleCredentialResponse(response) {
            try {
                // Decode JWT token ƒë·ªÉ l·∫•y th√¥ng tin user
                const responsePayload = decodeJwtResponse(response.credential);
                
                userInfo = {
                    name: responsePayload.name,
                    email: responsePayload.email,
                    picture: responsePayload.picture
                };

                // L·∫•y access token th√¥ng qua Google Identity Services
                const tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (tokenResponse) => {
                        accessToken = tokenResponse.access_token;
                        gapi.client.setToken({access_token: accessToken});
                        showUserInfo();
                        showMessage('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
                    },
                });

                tokenClient.requestAccessToken({prompt: 'consent'});
            } catch (error) {
                console.error('L·ªói x·ª≠ l√Ω ph·∫£n h·ªìi ƒëƒÉng nh·∫≠p:', error);
                showMessage('L·ªói ƒëƒÉng nh·∫≠p: ' + error.message, 'error');
            }
        }

        // Decode JWT token
        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // Hi·ªÉn th·ªã th√¥ng tin user v√† c√°c section
        function showUserInfo() {
            // ·∫®n section ƒëƒÉng nh·∫≠p
            document.getElementById('signInSection').classList.add('hidden');
            
            // Hi·ªÉn th·ªã th√¥ng tin user
            const userSection = document.getElementById('userSection');
            document.getElementById('userName').textContent = userInfo.name;
            document.getElementById('userEmail').textContent = userInfo.email;
            document.getElementById('userAvatar').src = userInfo.picture;
            userSection.classList.remove('hidden');

            // Hi·ªÉn th·ªã c√°c section ch·ª©c nƒÉng
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('filesSection').classList.remove('hidden');

            // Load danh s√°ch file
            loadFiles();
        }

        // ƒêƒÉng xu·∫•t
        function signOut() {
            // Reset access token v√† user info
            accessToken = null;
            userInfo = null;
            gapi.client.setToken(null);

            // ·∫®n c√°c section ch·ª©c nƒÉng
            document.getElementById('userSection').classList.add('hidden');
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('filesSection').classList.add('hidden');

            // Hi·ªÉn th·ªã section ƒëƒÉng nh·∫≠p
            document.getElementById('signInSection').classList.remove('hidden');

            // Clear file list
            document.getElementById('filesGrid').innerHTML = '';

            showMessage('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!', 'info');
        }

        // Upload file l√™n Google Drive
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (!files || files.length === 0) {
                showMessage('Vui l√≤ng ch·ªçn file ƒë·ªÉ t·∫£i l√™n!', 'error');
                return;
            }

            if (!accessToken) {
                showMessage('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi t·∫£i l√™n file!', 'error');
                return;
            }

            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';

            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    await uploadSingleFile(file, i + 1, files.length);
                }
                
                // Reset file input v√† reload danh s√°ch file
                fileInput.value = '';
                setTimeout(loadFiles, 1000);
                
            } catch (error) {
                console.error('L·ªói upload file:', error);
                showMessage('L·ªói upload file: ' + error.message, 'error');
            } finally {
                progressBar.style.display = 'none';
            }
        }

        // Upload m·ªôt file duy nh·∫•t
        async function uploadSingleFile(file, currentIndex, totalFiles) {
            const metadata = {
                name: file.name,
                parents: undefined // Upload v√†o th∆∞ m·ª•c root
            };

            const formData = new FormData();
            formData.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            formData.append('file', file);

            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = ((currentIndex - 1 + (e.loaded / e.total)) / totalFiles) * 100;
                        document.getElementById('progressFill').style.width = percentComplete + '%';
                    }
                });

                xhr.onload = function() {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        showMessage(`‚úÖ File "${file.name}" ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n th√†nh c√¥ng!`, 'success');
                        resolve(response);
                    } else {
                        reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
                    }
                };

                xhr.onerror = function() {
                    reject(new Error('L·ªói k·∫øt n·ªëi m·∫°ng'));
                };

                xhr.open('POST', 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart');
                xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
                xhr.send(formData);
            });
        }

        // Load danh s√°ch file t·ª´ Google Drive
        async function loadFiles() {
            if (!accessToken) {
                showMessage('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem danh s√°ch file!', 'error');
                return;
            }

            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.innerHTML = '<div class="loading"></div>';

            try {
                const params = {
                    pageSize: 12,
                    fields: 'nextPageToken, files(id, name, size, mimeType, modifiedTime, iconLink)',
                    orderBy: 'modifiedTime desc'
                };

                if (currentPageToken) {
                    params.pageToken = currentPageToken;
                }

                const response = await gapi.client.drive.files.list(params);
                const files = response.result.files;

                displayFiles(files);
                
                // C·∫≠p nh·∫≠t pagination
                updatePagination(response.result.nextPageToken);

            } catch (error) {
                console.error('L·ªói load file:', error);
                showMessage('L·ªói t·∫£i danh s√°ch file: ' + error.message, 'error');
            } finally {
                refreshIcon.innerHTML = 'üîÑ';
            }
        }

        // Hi·ªÉn th·ªã danh s√°ch file
        function displayFiles(files) {
            const filesGrid = document.getElementById('filesGrid');
            
            if (!files || files.length === 0) {
                filesGrid.innerHTML = '<p style="text-align: center; grid-column: 1/-1;">Kh√¥ng c√≥ file n√†o trong Google Drive c·ªßa b·∫°n.</p>';
                return;
            }

            filesGrid.innerHTML = files.map(file => `
                <div class="file-card">
                    <div class="file-icon">${getFileIcon(file.mimeType)}</div>
                    <div class="file-name" title="${file.name}">${file.name}</div>
                    <div class="file-info">
                        <div>K√≠ch th∆∞·ªõc: ${formatFileSize(file.size)}</div>
                        <div>S·ª≠a ƒë·ªïi: ${formatDate(file.modifiedTime)}</div>
                    </div>
                    <button class="btn btn-primary" onclick="downloadFile('${file.id}', '${file.name}')">
                        ‚¨áÔ∏è T·∫£i xu·ªëng
                    </button>
                </div>
            `).join('');
        }

        // L·∫•y icon cho file d·ª±a tr√™n mimeType
        function getFileIcon(mimeType) {
            if (!mimeType) return 'üìÑ';
            
            if (mimeType.includes('image/')) return 'üñºÔ∏è';
            if (mimeType.includes('video/')) return 'üé•';
            if (mimeType.includes('audio/')) return 'üéµ';
            if (mimeType.includes('pdf')) return 'üìï';
            if (mimeType.includes('document')) return 'üìù';
            if (mimeType.includes('spreadsheet')) return 'üìä';
            if (mimeType.includes('presentation')) return 'üìë';
            if (mimeType.includes('zip') || mimeType.includes('rar')) return 'üóúÔ∏è';
            if (mimeType.includes('text/')) return 'üìÑ';
            
            return 'üìÅ';
        }

        // Format k√≠ch th∆∞·ªõc file
        function formatFileSize(bytes) {
            if (!bytes) return 'N/A';
            
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Format ng√†y th√°ng
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN');
        }

        // Download file t·ª´ Google Drive
        async function downloadFile(fileId, fileName) {
            if (!accessToken) {
                showMessage('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫£i xu·ªëng file!', 'error');
                return;
            }

            try {
                showMessage('ƒêang t·∫£i xu·ªëng file...', 'info');

                // S·ª≠ d·ª•ng fetch ƒë·ªÉ t·∫£i file v·ªõi access token
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const blob = await response.blob();
                
                // T·∫°o URL ƒë·ªÉ download
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                showMessage(`‚úÖ File "${fileName}" ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng th√†nh c√¥ng!`, 'success');

            } catch (error) {
                console.error('L·ªói download file:', error);
                showMessage('L·ªói t·∫£i xu·ªëng file: ' + error.message, 'error');
            }
        }

        // Pagination functions
        function updatePagination(nextPageToken) {
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            const pageInfo = document.getElementById('pageInfo');

            // C·∫≠p nh·∫≠t th√¥ng tin trang
            const currentPage = previousPageTokens.length + 1;
            pageInfo.textContent = `Trang ${currentPage}`;

            // C·∫≠p nh·∫≠t n√∫t Previous
            prevBtn.disabled = previousPageTokens.length === 0;

            // C·∫≠p nh·∫≠t n√∫t Next
            nextBtn.disabled = !nextPageToken;

            // L∆∞u token cho trang ti·∫øp theo
            if (nextPageToken && !previousPageTokens.includes(currentPageToken)) {
                // Ch·ªâ th√™m v√†o previousPageTokens n·∫øu ch∆∞a c√≥
                if (currentPageToken) {
                    previousPageTokens.push(currentPageToken);
                }
            }
            
            // C·∫≠p nh·∫≠t currentPageToken cho trang ti·∫øp theo
            if (nextPageToken) {
                currentPageToken = nextPageToken;
            }
        }

        function nextPage() {
            loadFiles();
        }

        function previousPage() {
            if (previousPageTokens.length > 0) {
                // Quay v·ªÅ trang tr∆∞·ªõc
                previousPageTokens.pop(); // X√≥a token hi·ªán t·∫°i
                currentPageToken = previousPageTokens.length > 0 ? previousPageTokens[previousPageTokens.length - 1] : null;
                loadFiles();
            }
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o
        function showMessage(message, type) {
            // X√≥a c√°c message c≈©
            const oldMessages = document.querySelectorAll('.message');
            oldMessages.forEach(msg => msg.remove());

            // T·∫°o message m·ªõi
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;

            // Th√™m v√†o upload section
            const uploadSection = document.getElementById('uploadSection');
            if (uploadSection && !uploadSection.classList.contains('hidden')) {
                document.getElementById('uploadMessage').appendChild(messageDiv);
            } else {
                // N·∫øu upload section ·∫©n, th√™m v√†o auth section
                document.querySelector('.auth-section').appendChild(messageDiv);
            }

            // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // Drag and drop functionality
        const fileUploadArea = document.querySelector('.file-upload');
        
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.style.backgroundColor = 'rgba(102, 126, 234, 0.1)';
        });

        fileUploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileUploadArea.style.backgroundColor = '';
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.style.backgroundColor = '';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                uploadFile();
            }
        });
    </script>
</body>
</html>